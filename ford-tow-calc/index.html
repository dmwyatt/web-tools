<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ford F-150 Towing Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      }

      body {
        background-color: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 30px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #0052cc;
        margin-bottom: 24px;
        font-size: 24px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }

      input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
      }

      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
        resize: vertical;
      }

      .hint {
        display: block;
        margin-top: 6px;
        font-size: 14px;
        color: #666;
      }

      .small-btn {
        padding: 6px 12px;
        font-size: 14px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .small-btn:hover {
        background-color: #388e3c;
      }

      .extracted-vin-box {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        background-color: #f0f4f8;
        border: 1px solid #d0dae6;
        border-radius: 4px;
        margin-bottom: 10px;
      }

      .extracted-vin-box span {
        font-family: monospace;
        font-size: 18px;
        font-weight: 600;
        letter-spacing: 1px;
      }

      .warning-message {
        padding: 8px 12px;
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        color: #856404;
        margin-bottom: 10px;
      }

      .vin-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        margin-bottom: 6px;
        background-color: #f8f9fa;
        transition: background-color 0.2s;
      }

      .vin-option:hover {
        background-color: #e9ecef;
        cursor: pointer;
      }

      .vin-option.selected {
        background-color: #e3f2fd;
        border-color: #90caf9;
      }

      .error {
        padding: 15px;
        margin-bottom: 20px;
        background-color: #ffebee;
        border-left: 4px solid #d32f2f;
        color: #d32f2f;
      }

      .results {
        margin-top: 30px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        position: relative;
      }

      .results h2 {
        margin-bottom: 20px;
        font-size: 20px;
      }

      .results-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px;
      }

      @media (min-width: 768px) {
        .results-grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      h3 {
        margin-bottom: 12px;
        font-size: 18px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      tr {
        border-bottom: 1px solid #e9ecef;
      }

      td {
        padding: 10px 0;
        vertical-align: top;
      }

      td:first-child {
        color: #555;
        padding-right: 10px;
      }

      td:last-child {
        font-weight: 500;
      }

      .tow-rating {
        margin-top: 24px;
        padding: 16px;
        background-color: #e3f2fd;
        border-left: 4px solid #1976d2;
      }

      .tow-rating h3 {
        color: #0d47a1;
        margin-bottom: 8px;
      }

      .note {
        margin-top: 32px;
        font-size: 14px;
        color: #666;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
        vertical-align: middle;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 6px;
        z-index: 10;
      }

      .loading-overlay .loading {
        width: 30px;
        height: 30px;
        border: 3px solid rgba(0, 82, 204, 0.3);
        border-top-color: #0052cc;
        margin-bottom: 15px;
      }

      .loading-overlay p {
        color: #0052cc;
        font-weight: 500;
      }

      .graph-container {
        margin-top: 30px;
        padding: 20px;
        background-color: white;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }

      .graph-container h3 {
        margin-bottom: 16px;
        color: #0d47a1;
      }

      .chart-wrapper {
        position: relative;
        height: 400px;
      }

      .chart-legend {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 16px;
      }

      .legend-item {
        display: flex;
        align-items: center;
      }

      .legend-color {
        width: 16px;
        height: 16px;
        margin-right: 8px;
        border-radius: 3px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .url-input-container {
        display: flex;
        gap: 10px;
      }

      .url-input-container input {
        flex: 1;
      }

      #fetch-url-btn {
        background-color: #0052cc;
      }

      #fetch-url-btn:hover {
        background-color: #003d99;
      }

      .loading-btn {
        position: relative;
        pointer-events: none;
        color: transparent !important;
      }

      .loading-btn::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        margin: auto;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }

      /* NHTSA data styles */
      .nhtsa-data {
        margin-top: 30px;
        padding: 20px;
        background-color: #f8faff;
        border-radius: 6px;
        border: 1px solid #d0dae6;
      }

      .nhtsa-data h3 {
        color: #0d47a1;
        margin-bottom: 16px;
      }

      .nhtsa-data-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px;
      }

      @media (min-width: 768px) {
        .nhtsa-data-grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      .nhtsa-data-section {
        margin-bottom: 20px;
      }

      .nhtsa-logo {
        display: block;
        max-width: 100px;
        margin-bottom: 16px;
      }

      .data-source {
        font-size: 12px;
        color: #666;
        margin-top: 10px;
      }

      /* Show spinner for NHTSA data loading */
      .nhtsa-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Ford Truck Towing Calculator</h1>

      <div class="input-group">
        <label for="text-input">Enter or paste text containing VIN:</label>
        <textarea
          id="text-input"
          placeholder="Paste any text that contains a VIN..."
          rows="4"
        ></textarea>
        <span class="hint"
          >Tool will automatically extract VINs and calculate towing
          capacity</span
        >
      </div>

      <div class="input-group">
        <label for="url-input">Or enter a URL to search for VINs:</label>
        <div class="url-input-container">
          <input
            type="url"
            id="url-input"
            placeholder="https://example.com/page-with-vin"
          />
          <button id="fetch-url-btn" class="small-btn">Fetch</button>
        </div>
        <span class="hint"
          >Enter a web page URL that might contain VINs (may not work with all
          websites due to security restrictions)</span
        >
      </div>

      <div class="input-group extracted-vin-container" style="display: none">
        <label>Extracted VIN:</label>
        <div class="extracted-vin-box">
          <span id="extracted-vin">No VIN detected</span>
        </div>
        <div
          id="multiple-vin-warning"
          class="warning-message"
          style="display: none"
        >
          Multiple VINs detected! Please select one to use.
        </div>
        <div id="vin-list-container" style="display: none"></div>
      </div>

      <div class="input-group">
        <label for="occupant-weight">Occupant & Cargo Weight (lbs):</label>
        <input type="number" id="occupant-weight" value="700" min="0" />
        <span class="hint"
          >Default is 700 lbs (approx. 4 passengers + cargo). Changing weight
          updates calculation instantly.</span
        >
      </div>

      <div id="error-container" class="error" style="display: none"></div>

      <div id="results-container" class="results" style="display: none">
        <h2 id="vehicle-title">Results</h2>

        <div class="results-grid">
          <div>
            <h3>Vehicle Specifications</h3>
            <table>
              <tbody>
                <tr>
                  <td>VIN:</td>
                  <td id="result-vin"></td>
                </tr>
                <tr>
                  <td></td>
                  <td>
                    <a
                      id="window-sticker-link"
                      href="#"
                      target="_blank"
                      style="
                        font-size: 14px;
                        color: #0052cc;
                        text-decoration: underline;
                      "
                    >
                      View Window Sticker
                      <i style="font-size: 12px">(opens in new tab)</i>
                    </a>
                  </td>
                </tr>
                <tr>
                  <td>Maximum Payload:</td>
                  <td id="result-max-payload"></td>
                </tr>
                <tr>
                  <td>Maximum Conventional Towing:</td>
                  <td id="result-max-towing"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div>
            <h3>Towing Calculation</h3>
            <table>
              <tbody>
                <tr>
                  <td>Occupant & Cargo Weight:</td>
                  <td id="result-occupant-weight"></td>
                </tr>
                <tr>
                  <td>Available Payload:</td>
                  <td id="result-available-payload"></td>
                </tr>
                <tr>
                  <td>
                    Payload-Based Towing
                    <span style="font-size: 12px">(10% tongue weight)</span>:
                  </td>
                  <td id="result-payload-based-towing"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="tow-rating">
          <h3>Safe Tow Rating: <span id="result-safe-tow-rating"></span></h3>
          <p>
            This is the lower of the maximum conventional towing capacity and
            the payload-based towing capacity.
          </p>
        </div>

        <div class="graph-container">
          <h3>Tow Rating Analysis</h3>
          <p>
            This graph shows how your tow rating changes with different occupant
            weights and tongue weight percentages.
          </p>
          <div class="chart-wrapper">
            <canvas id="towRatingChart"></canvas>
          </div>
          <div class="chart-legend" id="chart-legend"></div>
        </div>

        <!-- NHTSA Data Section -->
        <div id="nhtsa-data-container" class="nhtsa-data">
          <h3>Additional Vehicle Data (NHTSA)</h3>
          <div id="nhtsa-loading" class="nhtsa-loading">
            <div class="loading"></div>
            <p>Loading NHTSA data...</p>
          </div>
          <div id="nhtsa-data-content" style="display: none">
            <div class="nhtsa-data-grid">
              <div class="nhtsa-data-section">
                <h4>Vehicle Details</h4>
                <table>
                  <tbody id="nhtsa-vehicle-details">
                    <!-- NHTSA vehicle details will be populated here -->
                  </tbody>
                </table>
              </div>
              <div class="nhtsa-data-section">
                <h4>Engine & Transmission</h4>
                <table>
                  <tbody id="nhtsa-engine-details">
                    <!-- NHTSA engine details will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
            <div class="data-source">
              Source: National Highway Traffic Safety Administration Vehicle API
            </div>
          </div>
        </div>
      </div>

      <p class="note">
        Note: This application connects directly to the Ford API and NHTSA API
        to fetch real data for Ford trucks. Enter a valid Ford truck VIN to get
        accurate towing calculations and comprehensive vehicle specifications.
      </p>

      <!-- Add UI elements for cache management -->
      <div
        class="cache-controls"
        style="margin-top: 15px; font-size: 14px; color: #666"
      >
        <button
          id="clear-cache-btn"
          style="
            padding: 5px 10px;
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 10px;
          "
        >
          Clear URL Cache
        </button>
        <span id="cache-status"></span>
      </div>
    </div>

    <script>
      // DOM Elements
      const textInput = document.getElementById("text-input");
      const occupantWeightInput = document.getElementById("occupant-weight");
      const calculateBtn = document.getElementById("calculate-btn");
      const errorContainer = document.getElementById("error-container");
      const resultsContainer = document.getElementById("results-container");
      const extractedVinContainer = document.querySelector(
        ".extracted-vin-container"
      );
      const extractedVinEl = document.getElementById("extracted-vin");
      const multipleVinWarning = document.getElementById(
        "multiple-vin-warning"
      );
      const vinListContainer = document.getElementById("vin-list-container");
      const urlInput = document.getElementById("url-input");
      const fetchUrlBtn = document.getElementById("fetch-url-btn");

      // URL Parameter Handling for shareable links
      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          vin: params.get("vin"),
          url: params.get("url"),
          weight: params.get("weight"),
        };
      }

      // Function to update URL with current parameters
      function updateUrlWithParams(params = {}) {
        // Create URL parameters object
        const urlParams = new URLSearchParams();

        // Add parameters if they exist
        if (params.vin) urlParams.set("vin", params.vin);
        if (params.url) urlParams.set("url", params.url);
        if (params.weight) urlParams.set("weight", params.weight);

        // Create the new URL
        const newUrl =
          window.location.pathname +
          (urlParams.toString() ? "?" + urlParams.toString() : "");

        // Update browser history without refreshing the page
        window.history.replaceState({}, "", newUrl);
      }

      // NHTSA related elements
      const nhtsaDataContainer = document.getElementById(
        "nhtsa-data-container"
      );
      const nhtsaLoading = document.getElementById("nhtsa-loading");
      const nhtsaDataContent = document.getElementById("nhtsa-data-content");
      const nhtsaVehicleDetails = document.getElementById(
        "nhtsa-vehicle-details"
      );
      const nhtsaEngineDetails = document.getElementById(
        "nhtsa-engine-details"
      );

      // Current selected VIN
      let selectedVin = null;
      // Storage for vehicle data to be used in graph
      let currentVehicleData = null;
      // Cache for storing VINs extracted from URLs
      let urlVinCache = {};

      // Load the URL VIN cache from localStorage on page load
      (function loadUrlVinCache() {
        try {
          const cachedData = localStorage.getItem("fordTowCalcUrlVinCache");
          if (cachedData) {
            urlVinCache = JSON.parse(cachedData);
            console.log(
              "Loaded URL VIN cache from localStorage:",
              Object.keys(urlVinCache).length,
              "entries"
            );
          }
        } catch (error) {
          console.error(
            "Error loading URL VIN cache from localStorage:",
            error
          );
          // If there's an error loading the cache, start with an empty one
          urlVinCache = {};
        }
      })();

      // Function to save the URL VIN cache to localStorage
      function saveUrlVinCache() {
        try {
          localStorage.setItem(
            "fordTowCalcUrlVinCache",
            JSON.stringify(urlVinCache)
          );
        } catch (error) {
          console.error("Error saving URL VIN cache to localStorage:", error);
        }
      }

      // Format number with commas
      function formatNumber(num) {
        return Math.round(num).toLocaleString();
      }

      // Function to extract VINs from text
      // VINs are 17 characters long and contain letters and numbers
      // They don't contain I, O, or Q to avoid confusion with 1 and 0
      function extractVins(text) {
        // Regex for finding potential VINs - 17 alphanumeric characters
        // excluding I, O, Q (letters commonly excluded from VINs)
        const vinRegex = /\b[A-HJ-NPR-Z0-9]{17}\b/gi;

        // Find all potential matches
        const matches = text.match(vinRegex) || [];

        // Basic Ford VIN check - first character should be F for Ford VINs
        // or 1F for Ford vehicles built in US
        // Filter matches and deduplicate
        const uniqueVins = [];
        const seenVins = new Set();

        return matches.filter((potentialVin) => {
          // Convert to uppercase for consistency
          potentialVin = potentialVin.toUpperCase();

          // Skip if we've already seen this VIN
          if (seenVins.has(potentialVin)) {
            return false;
          }

          // Perform basic VIN validation

          // Check for common patterns that aren't VINs
          // Example: reject strings like "u0022SharedNewVdp"
          if (
            potentialVin.includes("SHARED") ||
            potentialVin.includes("U0022") ||
            potentialVin.includes("\\U") ||
            /[A-Z0-9]{5}U[A-Z0-9]{11}/.test(potentialVin)
          ) {
            return false;
          }

          // More Ford-specific VIN validation
          // Most Ford VINs start with F or 1F
          // Position 10 should be a valid year character
          const validYearChars = "ABCDEFGHJKLMNPRSTVWXY123456789";
          const yearChar = potentialVin.charAt(9); // 10th character (0-indexed)

          // Basic structural validation
          const isLikelyVin =
            // Contains at least 2 letters and 5 numbers (most VINs have a mix)
            /[A-Z].*[A-Z]/.test(potentialVin) &&
            /[0-9].*[0-9].*[0-9].*[0-9].*[0-9]/.test(potentialVin) &&
            // Year character is valid
            validYearChars.includes(yearChar);

          // Only add if it passes validation
          if (isLikelyVin) {
            seenVins.add(potentialVin);
            return true;
          }

          return false;
        });
      }

      // API Call Function
      async function getF150TowRating(vin, occupantWeight) {
        // Ford API endpoint
        const API_ENDPOINT =
          "https://api.pd01e.gcp.ford.com/digitalservices/fs/api/v3/vehicles/vehicle-type";
        const CONSUMER_KEY = "Z28tbmEtZm9yZA=="; // Base64 encoded key

        try {
          // Call the Ford API
          const response = await fetch(
            `${API_ENDPOINT}?locale=en-us&country=USA`,
            {
              headers: {
                Accept: "application/json",
                "Consumer-Key": CONSUMER_KEY,
                Origin: "https://www.ford.com",
                Referer: "https://www.ford.com/",
                vin: vin,
              },
            }
          );

          if (!response.ok) {
            throw new Error(`Ford API error: ${response.status}`);
          }

          // Parse the response
          const data = await response.json();
          const vehicleData = data.vehicleData;

          // Get the payload and max tow values
          const maxPayload = parseInt(vehicleData.maximumPayloadPounds, 10);
          const maxTow = parseInt(vehicleData.maximumConventionalPounds, 10);

          // Calculate with custom occupant + cargo weight
          const availablePayload = maxPayload - occupantWeight;
          const payloadBasedTowing = availablePayload / 0.1; // 10% tongue weight

          // Get the safe tow rating (lower of payload-based or manufacturer max)
          const safeTowRating = Math.min(maxTow, payloadBasedTowing);

          return {
            vin: vehicleData.vin,
            model: vehicleData.model,
            year: vehicleData.year,
            maxPayloadPounds: maxPayload,
            maxConventionalTowing: maxTow,
            occupantAndCargoWeight: occupantWeight,
            availablePayload: availablePayload,
            payloadBasedTowing: payloadBasedTowing,
            calculatedTowRating: safeTowRating,
            rawResponse: data, // Include full API response for reference
          };
        } catch (error) {
          console.error(`Failed to get tow rating for VIN ${vin}:`, error);
          throw error;
        }
      }

      // Function to calculate tow ratings for various weight combinations
      function calculateTowRatingMatrix(maxPayload, maxTowing) {
        // Define ranges for the graph
        const occupantWeights = [300, 500, 700, 900, 1100, 1300, 1500];
        const tongueWeights = [0.08, 0.1, 0.12, 0.15];
        const tongueWeightLabels = ["8%", "10%", "12%", "15%"];

        // Generate datasets for each tongue weight percentage
        const datasets = tongueWeights.map((tongueWeight, index) => {
          const data = occupantWeights.map((weight) => {
            const availablePayload = maxPayload - weight;
            // Calculate payload-based towing (cannot be negative)
            const payloadBasedTowing = Math.max(
              0,
              availablePayload / tongueWeight
            );
            // Safe tow rating is the lower of payload-based or max towing
            return Math.min(maxTowing, payloadBasedTowing);
          });

          // Define colors for each line
          const colors = [
            "rgba(66, 133, 244, 1)", // Blue
            "rgba(219, 68, 55, 1)", // Red
            "rgba(244, 180, 0, 1)", // Yellow
            "rgba(15, 157, 88, 1)", // Green
          ];

          return {
            label: `${tongueWeightLabels[index]} Tongue Weight`,
            data: data,
            borderColor: colors[index],
            backgroundColor: colors[index].replace("1)", "0.1)"),
            tension: 0.1,
          };
        });

        return {
          labels: occupantWeights.map((weight) => `${weight} lbs`),
          datasets: datasets,
        };
      }

      // Function to render the tow rating chart
      function renderTowRatingChart(maxPayload, maxTowing) {
        const ctx = document.getElementById("towRatingChart").getContext("2d");

        // Calculate data for the chart
        const chartData = calculateTowRatingMatrix(maxPayload, maxTowing);

        // Destroy previous chart if it exists
        if (window.towChart) {
          window.towChart.destroy();
        }

        // Create the chart
        window.towChart = new Chart(ctx, {
          type: "line",
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: false,
                title: {
                  display: true,
                  text: "Towing Capacity (lbs)",
                },
                ticks: {
                  callback: function (value) {
                    return value.toLocaleString();
                  },
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Occupant & Cargo Weight",
                },
              },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return (
                      context.dataset.label +
                      ": " +
                      Math.round(context.raw).toLocaleString() +
                      " lbs"
                    );
                  },
                },
              },
              legend: {
                display: false,
              },
            },
          },
        });

        // Create custom legend
        const legendContainer = document.getElementById("chart-legend");
        legendContainer.innerHTML = "";

        chartData.datasets.forEach((dataset, index) => {
          const legendItem = document.createElement("div");
          legendItem.className = "legend-item";

          const colorBox = document.createElement("div");
          colorBox.className = "legend-color";
          colorBox.style.backgroundColor = dataset.borderColor;

          const label = document.createElement("span");
          label.textContent = dataset.label;

          legendItem.appendChild(colorBox);
          legendItem.appendChild(label);
          legendContainer.appendChild(legendItem);
        });
      }

      // Display Results Function
      function displayResults(results) {
        // Store the vehicle data globally for reference
        currentVehicleData = results;

        // Set all the result fields
        document.getElementById(
          "vehicle-title"
        ).textContent = `Results for ${results.year} ${results.model}`;
        document.getElementById("result-vin").textContent = results.vin;

        // Update window sticker link with the current VIN
        const windowStickerLink = document.getElementById(
          "window-sticker-link"
        );
        windowStickerLink.href = `https://www.windowsticker.forddirect.com/windowsticker.pdf?vin=${results.vin}`;

        document.getElementById(
          "result-max-payload"
        ).textContent = `${formatNumber(results.maxPayloadPounds)} lbs`;
        document.getElementById(
          "result-max-towing"
        ).textContent = `${formatNumber(results.maxConventionalTowing)} lbs`;
        document.getElementById(
          "result-occupant-weight"
        ).textContent = `${formatNumber(results.occupantAndCargoWeight)} lbs`;
        document.getElementById(
          "result-available-payload"
        ).textContent = `${formatNumber(results.availablePayload)} lbs`;
        document.getElementById(
          "result-payload-based-towing"
        ).textContent = `${formatNumber(results.payloadBasedTowing)} lbs`;
        document.getElementById(
          "result-safe-tow-rating"
        ).textContent = `${formatNumber(results.calculatedTowRating)} lbs`;

        // Show the results container
        resultsContainer.style.display = "block";

        // Render the tow rating chart
        renderTowRatingChart(
          results.maxPayloadPounds,
          results.maxConventionalTowing
        );
      }

      // Function to process input text and extract VINs
      function processInputText() {
        const text = textInput.value.trim();

        if (!text) {
          extractedVinContainer.style.display = "none";
          return;
        }

        // Extract VINs
        const vins = extractVins(text);

        // Show the VIN container
        extractedVinContainer.style.display = "block";

        if (vins.length === 0) {
          // No VINs found
          extractedVinEl.textContent = "No VIN detected";
          multipleVinWarning.style.display = "none";
          vinListContainer.style.display = "none";
          selectedVin = null;
        } else if (vins.length === 1) {
          // Single VIN found - automatically select it and calculate
          extractedVinEl.textContent = vins[0];
          multipleVinWarning.style.display = "none";
          vinListContainer.style.display = "none";
          selectedVin = vins[0];

          // Automatically trigger calculation
          performCalculation(selectedVin);
        } else {
          // Multiple VINs found
          extractedVinEl.textContent = "Multiple VINs detected";
          multipleVinWarning.style.display = "block";
          vinListContainer.style.display = "block";

          // Create a list of VIN options
          vinListContainer.innerHTML = "";
          vins.forEach((vin) => {
            const vinOption = document.createElement("div");
            vinOption.className = "vin-option";
            vinOption.innerHTML = `
            <span>${vin}</span>
            <button class="small-btn select-vin-btn">Select</button>
          `;

            // Add click handler for the button
            const selectBtn = vinOption.querySelector(".select-vin-btn");
            selectBtn.addEventListener("click", function () {
              selectedVin = vin;
              extractedVinEl.textContent = vin;

              // Highlight the selected VIN
              document.querySelectorAll(".vin-option").forEach((option) => {
                option.classList.remove("selected");
              });
              vinOption.classList.add("selected");

              // Automatically trigger calculation with the selected VIN
              performCalculation(selectedVin);
            });

            vinListContainer.appendChild(vinOption);
          });

          // Reset selected VIN
          selectedVin = null;
        }
      }

      // Function to perform the tow rating calculation
      async function performCalculation(vin) {
        // Show loading indicator in results section
        if (resultsContainer.style.display === "block") {
          // If already displaying results, show a loading overlay
          let loadingOverlay = document.getElementById("loading-overlay");
          if (!loadingOverlay) {
            loadingOverlay = document.createElement("div");
            loadingOverlay.id = "loading-overlay";
            loadingOverlay.className = "loading-overlay";
            loadingOverlay.innerHTML =
              '<div class="loading"></div><p>Updating...</p>';
            resultsContainer.appendChild(loadingOverlay);
          } else {
            loadingOverlay.style.display = "flex";
          }
        }

        // Reset NHTSA section to loading state
        if (nhtsaDataContainer) {
          nhtsaLoading.style.display = "flex";
          nhtsaDataContent.style.display = "none";
        }

        errorContainer.style.display = "none";

        try {
          const occupantWeight = parseInt(occupantWeightInput.value, 10) || 700;

          // Call Ford API and get results
          const results = await getF150TowRating(vin, occupantWeight);

          // Display results
          displayResults(results);

          // Update URL with the VIN and weight parameters
          updateUrlWithParams({
            vin: vin,
            weight: occupantWeight,
          });

          // Fetch and display NHTSA data
          try {
            const nhtsaData = await getNHTSAVehicleData(vin);
            displayNHTSAData(nhtsaData);
          } catch (nhtsaError) {
            console.error("Error fetching NHTSA data:", nhtsaError);
            // Display error in NHTSA section
            nhtsaLoading.style.display = "none";
            nhtsaDataContent.style.display = "block";
            nhtsaDataContent.innerHTML = `
              <div class="error">
                <p>Unable to retrieve NHTSA data: ${nhtsaError.message}</p>
              </div>
            `;
          }
        } catch (error) {
          // Show error
          errorContainer.textContent =
            error.message || "An error occurred while fetching vehicle data";
          errorContainer.style.display = "block";
          resultsContainer.style.display = "none";
        } finally {
          // Remove loading overlay if it exists
          const loadingOverlay = document.getElementById("loading-overlay");
          if (loadingOverlay) {
            loadingOverlay.style.display = "none";
          }
        }
      }

      // Event for processing pasted text
      textInput.addEventListener("input", processInputText);

      // Add event listener for occupant weight to recalculate in real-time
      occupantWeightInput.addEventListener("input", function () {
        if (selectedVin) {
          performCalculation(selectedVin);
        }
      });

      // Function to fetch content from a URL
      async function fetchUrlContent(url) {
        // Check and normalize URL
        if (!url.startsWith("http://") && !url.startsWith("https://")) {
          url = "https://" + url;
        }

        // Show loading state
        fetchUrlBtn.classList.add("loading-btn");
        fetchUrlBtn.textContent = "";
        errorContainer.style.display = "none";

        // Update URL with the target URL parameter
        updateUrlWithParams({ url: url });

        // First check if we have this URL cached
        if (urlVinCache[url]) {
          console.log("Using cached VINs for URL:", url);
          const cachedVins = urlVinCache[url];

          if (cachedVins.length > 0) {
            // Display a message that we're using cached data
            textInput.value =
              "Using cached VINs from URL: " + cachedVins.join(", ");
            processInputText();

            // If only one VIN found, auto-select it
            if (cachedVins.length === 1) {
              selectedVin = cachedVins[0];
              performCalculation(selectedVin);
            }

            // Reset loading state and return
            fetchUrlBtn.classList.remove("loading-btn");
            fetchUrlBtn.textContent = "Fetch";
            return true;
          }
        }

        // First check if the URL itself contains a VIN
        console.log("Checking URL for VINs:", url);
        const urlVins = extractVins(url);

        if (urlVins.length > 0) {
          console.log("Found VIN(s) in URL:", urlVins);

          // Cache the VINs found in the URL
          urlVinCache[url] = urlVins;
          saveUrlVinCache();

          // Display the found VINs
          textInput.value = "VIN found in URL: " + urlVins.join(", ");
          processInputText();

          // If only one VIN found, auto-select it
          if (urlVins.length === 1) {
            selectedVin = urlVins[0];
            performCalculation(selectedVin);
          }

          // Reset loading state and return
          fetchUrlBtn.classList.remove("loading-btn");
          fetchUrlBtn.textContent = "Fetch";
          return true;
        }

        // If no VIN in URL, proceed with fetching the page content
        try {
          // Try direct fetch first
          console.log(
            "No VIN found in URL. Attempting direct fetch of URL:",
            url
          );
          const directResponse = await fetch(url);

          // If successful, process the response
          const html = await directResponse.text();
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = html;
          const text = tempDiv.textContent || tempDiv.innerText || "";

          // Extract VINs from the text
          const extractedVins = extractVins(text);

          // Cache the extracted VINs
          if (extractedVins.length > 0) {
            urlVinCache[url] = extractedVins;
            saveUrlVinCache();
            console.log("Cached", extractedVins.length, "VINs for URL:", url);
          }

          // Set the text in the text input and process it
          textInput.value = text;
          processInputText();

          console.log("Direct fetch successful");
          return true;
        } catch (directError) {
          // If direct fetch fails, try with CORS proxy
          console.log("Direct fetch failed:", directError.message);

          // Try multiple proxies in sequence
          const proxies = [
            {
              name: "corsproxy.io",
              url: "https://corsproxy.io/?",
              urlFormatter: (targetUrl) =>
                "https://corsproxy.io/?" + encodeURIComponent(targetUrl),
            },
            {
              name: "allorigins.win",
              url: "https://api.allorigins.win/raw?url=",
              urlFormatter: (targetUrl) =>
                "https://api.allorigins.win/raw?url=" +
                encodeURIComponent(targetUrl),
            },
            {
              name: "cors-anywhere (limited)",
              url: "https://cors-anywhere.herokuapp.com/",
              urlFormatter: (targetUrl) =>
                "https://cors-anywhere.herokuapp.com/" + targetUrl,
            },
          ];

          // Try each proxy in sequence
          for (const proxy of proxies) {
            try {
              console.log(`Attempting fetch with ${proxy.name} proxy`);
              const proxyUrl = proxy.urlFormatter(url);
              const proxyResponse = await fetch(proxyUrl);

              // Check if we got an actual response
              if (!proxyResponse.ok) {
                console.log(
                  `${proxy.name} proxy returned ${proxyResponse.status}: ${proxyResponse.statusText}`
                );

                // If 404 from the proxy, try the next one
                if (proxyResponse.status === 404) {
                  console.log(
                    `404 error from ${proxy.name}, trying next proxy`
                  );
                  continue;
                }

                throw new Error(
                  `${proxy.name} proxy error: ${proxyResponse.status}`
                );
              }

              // Get the HTML content as text
              const html = await proxyResponse.text();

              // Convert HTML to plain text
              const tempDiv = document.createElement("div");
              tempDiv.innerHTML = html;
              const text = tempDiv.textContent || tempDiv.innerText || "";

              // Extract VINs from the text
              const extractedVins = extractVins(text);

              // Cache the extracted VINs
              if (extractedVins.length > 0) {
                urlVinCache[url] = extractedVins;
                saveUrlVinCache();
                console.log(
                  "Cached",
                  extractedVins.length,
                  "VINs for URL:",
                  url
                );
              }

              // Set the text in the text input and process it
              textInput.value = text;
              processInputText();

              console.log(`${proxy.name} proxy fetch successful`);
              return true;
            } catch (proxyError) {
              console.error(
                `${proxy.name} proxy attempt failed:`,
                proxyError.message
              );
              // Continue to the next proxy
            }
          }

          // If we get here, all proxies failed
          errorContainer.textContent = `Error fetching URL: All proxy attempts failed. The site may be blocking access or the URL might be invalid.`;
          errorContainer.style.display = "block";
          return false;
        } finally {
          // Reset loading state
          fetchUrlBtn.classList.remove("loading-btn");
          fetchUrlBtn.textContent = "Fetch";
        }
      }

      // Add event listener for URL fetch button
      fetchUrlBtn.addEventListener("click", function () {
        const url = urlInput.value.trim();
        if (url) {
          fetchUrlContent(url);
        } else {
          errorContainer.textContent = "Please enter a valid URL";
          errorContainer.style.display = "block";
        }
      });

      // Add event listener for URL input to allow pressing Enter
      urlInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          const url = urlInput.value.trim();
          if (url) {
            fetchUrlContent(url);
          } else {
            errorContainer.textContent = "Please enter a valid URL";
            errorContainer.style.display = "block";
          }
        }
      });

      // NHTSA API Function to get vehicle data from VIN
      async function getNHTSAVehicleData(vin) {
        try {
          // Use the NHTSA API's DecodeVinValues endpoint (flat format for easier processing)
          const apiUrl = `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValues/${vin}?format=json`;

          const response = await fetch(apiUrl);

          if (!response.ok) {
            throw new Error(`NHTSA API error: ${response.status}`);
          }

          const data = await response.json();

          // The API returns an array of results, but we only need the first one
          if (data.Results && data.Results.length > 0) {
            return data.Results[0];
          } else {
            throw new Error("No data returned from NHTSA API");
          }
        } catch (error) {
          console.error(`Failed to get NHTSA data for VIN ${vin}:`, error);
          throw error;
        }
      }

      // Function to display NHTSA data
      function displayNHTSAData(nhtsaData) {
        // Clear previous data
        nhtsaVehicleDetails.innerHTML = "";
        nhtsaEngineDetails.innerHTML = "";

        // Vehicle details section
        const vehicleDetails = [
          { label: "Make", value: nhtsaData.Make },
          { label: "Model", value: nhtsaData.Model },
          { label: "Model Year", value: nhtsaData.ModelYear },
          { label: "Trim", value: nhtsaData.Trim || "N/A" },
          { label: "Vehicle Type", value: nhtsaData.VehicleType || "N/A" },
          { label: "Body Class", value: nhtsaData.BodyClass || "N/A" },
          { label: "Doors", value: nhtsaData.Doors || "N/A" },
          { label: "GVWR", value: nhtsaData.GVWR || "N/A" },
          { label: "Plant Country", value: nhtsaData.PlantCountry || "N/A" },
          { label: "Plant City", value: nhtsaData.PlantCity || "N/A" },
        ];

        // Engine & transmission details
        const engineDetails = [
          { label: "Engine Type", value: nhtsaData.EngineModel || "N/A" },
          {
            label: "Displacement (L)",
            value: nhtsaData.DisplacementL || "N/A",
          },
          { label: "Cylinders", value: nhtsaData.EngineCylinders || "N/A" },
          { label: "Fuel Type", value: nhtsaData.FuelTypePrimary || "N/A" },
          {
            label: "Transmission Style",
            value: nhtsaData.TransmissionStyle || "N/A",
          },
          {
            label: "Transmission Speeds",
            value: nhtsaData.TransmissionSpeeds || "N/A",
          },
          { label: "Drive Type", value: nhtsaData.DriveType || "N/A" },
          { label: "Axles", value: nhtsaData.Axles || "N/A" },
          {
            label: "Trailer Type Connection",
            value: nhtsaData.TrailerTypeConnection || "N/A",
          },
          {
            label: "Trailer Body Type",
            value: nhtsaData.TrailerBodyType || "N/A",
          },
        ];

        // Populate vehicle details
        vehicleDetails.forEach((detail) => {
          if (
            detail.value &&
            detail.value !== "" &&
            detail.value !== "Not Applicable"
          ) {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${detail.label}:</td>
              <td>${detail.value}</td>
            `;
            nhtsaVehicleDetails.appendChild(row);
          }
        });

        // Populate engine details
        engineDetails.forEach((detail) => {
          if (
            detail.value &&
            detail.value !== "" &&
            detail.value !== "Not Applicable"
          ) {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${detail.label}:</td>
              <td>${detail.value}</td>
            `;
            nhtsaEngineDetails.appendChild(row);
          }
        });

        // Show the NHTSA data content
        nhtsaLoading.style.display = "none";
        nhtsaDataContent.style.display = "block";
      }

      // Update cache status display
      function updateCacheStatus() {
        const cacheEntries = Object.keys(urlVinCache).length;
        document.getElementById(
          "cache-status"
        ).textContent = `URL cache: ${cacheEntries} ${
          cacheEntries === 1 ? "entry" : "entries"
        }`;
      }

      // Initialize: Check for URL parameters and process them
      document.addEventListener("DOMContentLoaded", function () {
        const params = getUrlParams();

        // If we have a VIN parameter, use it directly
        if (params.vin) {
          console.log("VIN found in URL parameters:", params.vin);
          selectedVin = params.vin;

          // Autofill the text input with the VIN
          textInput.value = params.vin;

          // Update the extracted VIN display
          extractedVinEl.textContent = params.vin;
          extractedVinContainer.style.display = "block";

          // If we have a weight parameter, set it
          if (params.weight) {
            occupantWeightInput.value = params.weight;
          }

          // Perform calculation with the VIN
          performCalculation(params.vin);
        }
        // If we have a URL parameter, fetch from that URL
        else if (params.url) {
          console.log("URL found in URL parameters:", params.url);
          urlInput.value = params.url;
          fetchUrlContent(params.url);
        }

        // Update cache status display
        updateCacheStatus();
      });

      // Add event listener for clear cache button
      document
        .getElementById("clear-cache-btn")
        .addEventListener("click", function () {
          urlVinCache = {};
          localStorage.removeItem("fordTowCalcUrlVinCache");
          updateCacheStatus();
          alert("URL cache has been cleared");
        });
    </script>
  </body>
</html>
